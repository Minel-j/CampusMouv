{% extends 'base.html.twig' %}

{% block title %}Détails de la sortie | {{ parent() }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
{% endblock %}

{% block main %}
    {# Messages flash #}
    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="uk-alert-{{ label }} uk-margin" uk-alert>
                <a class="uk-alert-close" uk-close></a>
                <p>{{ message }}</p>
            </div>
        {% endfor %}
    {% endfor %}

    {# Règles d'inscription #}
    {% set now = 'now'|date('U') %}
    {% set delais_depasse = sortie.dateLimiteInscription|date('U') < now %}
    {% set deja_debute = sortie.dateHeureDebut|date('U') <= now %}
    {% set inscrits = sortie.participants|length %}
    {% set complet = sortie.nbInscriptionMax is not null and inscrits >= sortie.nbInscriptionMax %}

    {# {% set pas_ouverte = sortie.etat != constant('App\\\\Enum\\\\Etat::OUVERTE') %} #}




    {# Header #}
    <section class="uk-section uk-preserve-color cm-background-charcoal uk-light">
        <div class="uk-container uk-container-large">
            <div class="uk-text-center">
                <h1 class="uk-heading-large uk-margin-remove-bottom">{{ sortie.nom }}</h1>
                <p class="uk-text-large uk-margin-small-top cm-text-saffron">Tous les détails de l'activité</p>
            </div>
        </div>
    </section>

    {#  Section détails  #}
    <section class="uk-section uk-section-default">
        <div class="uk-container uk-container-large">
            <div class="uk-grid-large" uk-grid>

                {# -------- Colonne image -------- #}
                <div class="uk-width-1-2@m">
                    <div class="uk-card uk-card-default uk-border-rounded uk-overflow-hidden uk-height-1-1">
                        <div class="uk-card-media-top uk-inline uk-transition-toggle uk-margin-medium-bottom">
                            <img class="uk-transition-scale-up uk-transition-opaque uk-width-1-1 center"

                                    {% if sortie.photo %}
                                        src="{{ sortie.photo }}"
                                    {% else %}
                                        data-src="https://picsum.photos/400/300/?random={{ sortie.id }}"
                                    {% endif %}
                                 alt="{{ sortie.nom }}"
                                 uk-img>

                            {# Badge statut #}
                            <div class="uk-position-top-right uk-position-small">
                                {# {% if pas_ouverte %}
                                    <span class="uk-label cm-background-burnt-sienna uk-light uk-text-bold">Non ouverte</span> #}
                                {% if delais_depasse %}
                                    <span class="uk-label cm-background-sandy-brown uk-light uk-text-bold">Inscriptions fermées</span>
                                {% elseif complet and not (app.user and sortie.participants.contains(app.user)) %}
                                    <span class="uk-label cm-background-burnt-sienna uk-light uk-text-bold">Complet</span>
                                {% elseif app.user and sortie.participants.contains(app.user) %}
                                    <span class="uk-label uk-label-success uk-text-bold">Inscrit</span>
                                {% else %}
                                    <span class="uk-label cm-background-persian-green uk-light uk-text-bold">Disponible</span>
                                {% endif %}
                                <span class="uk-label cm-background-burnt-sienna uk-light">{{ sortie.etat.name }}</span>
                            </div>
                        </div>
                        <div>
                            <label class="uk-form-label">Localisation</label>
                            <div id="sortie-map"
                                 data-nom="{{ sortie.lieu.nom }}"
                                 data-rue="{{ sortie.lieu.rue }}"
                                 data-ville="{{ sortie.lieu.ville.nom }}"
                                 data-cp="{{ sortie.lieu.ville.cp }}"
                                 data-lat="{{ sortie.lieu.latitude }}"
                                 data-lng="{{ sortie.lieu.longitude }}"
                                 style="height: 350px; width: 100%; border-radius: 5px; border: 1px solid #e5e5e5;">
                            </div>

                        </div>
                    </div>
                </div>

                {# -------- Colonne infos -------- #}
                <div class="uk-width-1-2@m">
                    <div class="uk-card uk-card-default uk-border-rounded uk-height-1-1">

                        {# En-tête #}
                        <div class="uk-card-header uk-padding-small"
                             style="background-color:#f8f9fa;border-bottom:1px solid #e9ecef;">
                            <h3 class="uk-card-title uk-margin-remove-bottom cm-text-charcoal">Informations de la
                                sortie</h3>
                            <p class="uk-text-meta uk-margin-small-top uk-text-small cm-text-charcoal"
                               style="opacity:.7;">
                                {{ sortie.infos ?: 'Découvrez tous les détails de cette activité' }}
                            </p>
                        </div>

                        {# Corps #}
                        <div class="uk-card-body uk-padding-small">

                            {# Date début #}
                            <div class="uk-flex uk-flex-middle uk-margin-small-bottom">
                                <span uk-icon="icon: calendar; ratio: .9"
                                      class="cm-text-persian-green uk-margin-small-right"></span>
                                <div>
                                    <div class="uk-text-small uk-text-bold cm-text-charcoal">
                                        {{ sortie.dateHeureDebut|date('d/m/Y H:i') }}
                                    </div>
                                    <div class="uk-text-meta uk-text-small">Date et heure de début</div>
                                </div>
                            </div>

                            {# Limite d'inscription #}
                            <div class="uk-flex uk-flex-middle uk-margin-small-bottom">
                                <span uk-icon="icon: clock; ratio: 0.8"
                                      class="cm-text-sandy-brown uk-margin-small-right"></span>
                                <div>
                                    <div class="uk-text-small uk-text-bold cm-text-charcoal">
                                        {{ sortie.dateLimiteInscription|date('d/m/Y H:i') }}
                                    </div>
                                    <div class="uk-text-meta uk-text-small">Limite d'inscription</div>
                                </div>
                            </div>

                            {# Durée #}
                            <div class="uk-flex uk-flex-middle uk-margin-small-bottom">
                                <span uk-icon="icon: clock; ratio: .9"
                                      class="cm-text-sandy-brown uk-margin-small-right"></span>
                                <div>
                                    <div class="uk-text-small uk-text-bold cm-text-charcoal">{{ sortie.duree }}
                                        minutes
                                    </div>
                                    <div class="uk-text-meta uk-text-small">Durée de l'activité</div>
                                </div>
                            </div>

                            {# Lieu #}
                            <div class="uk-flex uk-flex-middle uk-margin-small-bottom">
                                <span uk-icon="icon: location; ratio: .9"
                                      class="cm-text-persian-green uk-margin-small-right"></span>
                                <div>
                                    <div class="uk-text-small uk-text-bold cm-text-charcoal">{{ sortie.campus.nom }}</div>
                                    <div class="uk-text-meta uk-text-small">Lieu de rendez-vous</div>
                                </div>
                            </div>

                            {# Organisateur #}
                            <div class="uk-flex uk-flex-middle uk-margin-small-bottom">
                                <span uk-icon="icon: user; ratio: .9"
                                      class="cm-text-sandy-brown uk-margin-small-right"></span>
                                <div>
                                    <div class="uk-text-small uk-text-bold cm-text-charcoal">
                                        {% if sortie.organisateur %}
                                            <a class="uk-text-small cm-text-charcoal"
                                               href="{{ path('profil_detail', {slug: sortie.organisateur.slug}) }}">
                                                {{ sortie.organisateur.prenom | capitalize ~ ' ' ~ sortie.organisateur.nom | first ~ '.' }}</a>
                                        {% else %}
                                            L'utilisateur organisateur a été supprimé
                                        {% endif %}
                                    </div>

                                    <div class="uk-text-meta uk-text-small">Organisateur</div>
                                </div>
                            </div>

                            {# Participants + jauge #}
                            <div class="uk-margin-small-bottom">
                                <div class="uk-flex uk-flex-between uk-flex-middle uk-margin-small-bottom">
                                    <span class="uk-flex uk-flex-middle">
                                        <span uk-icon="icon: users; ratio: .9"
                                              class="cm-text-persian-green uk-margin-small-right"></span>
                                        <span class="uk-text-small cm-text-charcoal">Participants inscrits</span>
                                    </span>
                                    <span class="uk-text-small uk-text-bold cm-text-charcoal">
                                        {{ inscrits }}{% if sortie.nbInscriptionMax %} / {{ sortie.nbInscriptionMax }}{% endif %}
                                    </span>
                                </div>

                                {% if sortie.nbInscriptionMax %}
                                    <progress class="uk-progress uk-progress-small uk-margin-small-bottom"
                                              value="{{ inscrits }}"
                                              max="{{ sortie.nbInscriptionMax }}">
                                    </progress>
                                {% endif %}
                            </div>
                        </div>

                        {# Compteur #}
                        <p class="uk-text-small uk-text-bold">
                            {{ sortie.participants|length }} participant(s)
                            {# / {{ sortie.nbInscriptionMax }} si tu veux l’afficher #}
                        </p>

                        {# Liste #}
                        {% if sortie.participants|length == 0 %}
                            <p class="uk-text-meta">Aucun participant pour le moment.</p>
                        {% else %}
                            <ul class="uk-list uk-list-divider">
                                {% for u in sortie.participants %}
                                    <li class="uk-flex uk-flex-middle uk-flex-between">
                                        <div class="uk-flex uk-flex-middle">
                                            {% if u.photo is defined and u.photo %}
                                                <img src="{{ u.photo }}" alt="Photo de profil de {{ u.prenom ~ u.nom }}"
                                                     class="uk-border-circle uk-margin-small-right" width="32"
                                                     height="32">
                                            {% else %}
                                                <div class="uk-border-circle uk-background-muted uk-flex uk-flex-center uk-flex-middle uk-margin-small-right"
                                                     style="width:32px;height:32px;">
                                                    {{ u.prenom|first|upper }}
                                                </div>
                                            {% endif %}

                                            <div>
                                                <div class="uk-text-small uk-text-bold">

                                                    <a class="uk-text-small cm-text-charcoal"
                                                       href="{{ path('profil_detail', {slug: u.slug}) }}">
                                                        {{ u.prenom | capitalize ~ ' ' ~ u.nom | first ~ '.' }}</a>

                                                    {% if app.user and u.id == app.user.id %}
                                                        <span class="uk-label uk-label-success uk-margin-small-left">vous</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% endif %}



                        {# Footer : actions #}
                        <div class="uk-card-footer uk-padding-small uk-text-center"
                             style="background-color:#f8f9fa;border-top:1px solid #e9ecef;">
                            {% if app.user and sortie.participants.contains(app.user) %}
                                {# Déjà inscrit → se désinscrire #}
                                <form action="{{ path('sorties_desinscription', {id: sortie.id}) }}" method="post"
                                      class="uk-width-1-1">
                                    <button type="submit"
                                            class="uk-button uk-border-pill uk-button-primary uk-width-1-1 uk-button-red">
                                        <span uk-icon="close"></span> Se désinscrire
                                    </button>
                                </form>

                            {% elseif app.user %}
                                {# Non inscrit : calcul des raisons d'indisponibilité #}
                                {% set conditions = [] %}
                                {# {% if pas_ouverte %}{% set conditions = conditions|merge(['Sortie non ouverte']) %}{% endif %} #}
                                {% if delais_depasse %}{% set conditions = conditions|merge(['Date limite dépassée']) %}{% endif %}
                                {% if complet %}{% set conditions = conditions|merge(['Sortie complète']) %}{% endif %}
                                {% if deja_debute %}
                                    <button class="uk-button uk-button-danger uk-light uk-button-large uk-width-1-1"
                                            disabled
                                            title="La sortie a déjà débuté">
                                        <span uk-icon="ban"></span> Désinscription indisponible
                                    </button>
                                {% endif %}
                                {% if conditions|length > 0 %}
                                    <button class="uk-button cm-background-burnt-sienna uk-light uk-button-large uk-width-1-1"
                                            disabled
                                            title="{{ conditions|join(' • ') }}">
                                        <span uk-icon="ban"></span> Inscription indisponible
                                    </button>

                                {% else %}
                                    <form action="{{ path('sorties_inscription', {id: sortie.id}) }}" method="post"
                                          class="uk-width-1-1">
                                        <button type="submit"
                                                class="uk-button uk-border-pill uk-button-primary uk-width-1-1 uk-button-green">
                                            <span uk-icon="check"></span> Je m'inscris à cette sortie
                                        </button>
                                    </form>
                                {% endif %}

                            {% else %}
                                {# Pas connecté #}
                                <a href="{{ path('app_login') }}"
                                   class="uk-button cm-background-persian-green uk-light uk-button-large uk-width-1-1">
                                    <span uk-icon="sign-in"></span> Connectez-vous pour vous inscrire
                                </a>
                            {% endif %}
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </section>
    {# App\Enum\Etat::ANNULEE #}
    {% if sortie.etat.name is not same as 'ANNULEE' %}
        {% if app.user is same as sortie.organisateur %}
            <button class="uk-button uk-button-danger uk-dark uk-button-large uk-width-1-1"
                    uk-toggle="target: #modal-delete-{{ sortie.id }}">
                <span uk-icon="trash"></span> Annuler la sortie
            </button>

            <div id="modal-delete-{{ sortie.id }}" uk-modal>
                <div class="uk-modal-dialog uk-modal-body">
                    <h2 class="uk-modal-title">Confirmer la suppression</h2>
                    <p>Êtes-vous sûr de vouloir supprimer cette sortie ?</p>
                    <div class="uk-flex uk-flex-right uk-flex-middle uk-grid-small" uk-grid>
                        <div>
                            <button class="uk-button uk-button-default uk-modal-close" type="button">Annuler</button>
                        </div>
                        <div>
                            <form method="post" action="{{ path('sorties_cancel', {'id': sortie.id}) }}">
                                <button type="submit" class="uk-button-default uk-margin-small-right uk-button-red">Annuler la sortie</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    {% endif %}


    <section class="uk-section cm-background-charcoal uk-light uk-section-large">
        <div class="uk-container uk-text-center">
            <h2 class="uk-heading-medium">Découvrez d'autres sorties</h2>
            <p class="uk-text-large uk-margin-medium-bottom cm-text-saffron">Explorez toutes les activités
                disponibles</p>
            <a href="{{ path('sorties_home') }}" class="uk-button cm-background-persian-green uk-light uk-button-large">
                <span uk-icon="grid"></span> Voir toutes les sorties
            </a>
        </div>
    </section>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <!-- Scripts JavaScript de l'application -->
{#    <script src="{{ asset('js/sortie-form.js') }}" defer></script>#}
    <script src="{{ asset('js/sortie-map-detail.js') }}" defer></script>
{% endblock %}