{% extends 'base.html.twig' %}

{% block title %}Détails de la sortie{% endblock %}

{% block main %}
    {# Messages flash #}
    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="uk-alert-{{ label }} uk-margin" uk-alert>
                <a class="uk-alert-close" uk-close></a>
                <p>{{ message }}</p>
            </div>
        {% endfor %}
    {% endfor %}

    {#Règles d'inscription #}
    {% set now = 'now'|date('U') %}
    {% set delais_depasse = sortie.dateLimiteInscription|date('U') < now %}
    {% set deja_debute = sortie.dateHeureDebut|date('U') <= now %}
    {% set inscrits = sortie.participants|length %}
    {% set complet = sortie.nbInscriptionMax is not null and inscrits >= sortie.nbInscriptionMax %}

    {#{% set pas_ouverte = sortie.etat != constant('App\\\\Enum\\\\Etat::OUVERTE') %}#}




    {# Header #}
    <section class="uk-section uk-preserve-color cm-background-charcoal uk-light">
        <div class="uk-container uk-container-large">
            <div class="uk-text-center">
                <h1 class="uk-heading-large uk-margin-remove-bottom">{{ sortie.nom }}</h1>
                <p class="uk-text-large uk-margin-small-top cm-text-saffron">Tous les détails de l'activité</p>
            </div>
        </div>
    </section>

    {#  Section détails  #}
    <section class="uk-section uk-section-default">
        <div class="uk-container uk-container-large">
            <div class="uk-grid-large" uk-grid>

                {# -------- Colonne image -------- #}
                <div class="uk-width-1-2@m">
                    <div class="uk-card uk-card-default uk-border-rounded uk-overflow-hidden uk-height-1-1">
                        <div class="uk-card-media-top uk-inline uk-transition-toggle">
                            <img class="uk-transition-scale-up uk-transition-opaque uk-width-1-1"

                                    {% if sortie.photo %}
                                        src="{{ sortie.photo }}"
                                    {% else %}
                                        data-src="https://picsum.photos/400/300/?random={{ sortie.id }}"
                                    {% endif %}
                                 alt="{{ sortie.nom }}"
                                 uk-img>

                            {# Badge statut #}
                            <div class="uk-position-top-right uk-position-small">
                                {# {% if pas_ouverte %}
                                    <span class="uk-label cm-background-burnt-sienna uk-light uk-text-bold">Non ouverte</span>#}
                                {% if delais_depasse %}
                                    <span class="uk-label cm-background-sandy-brown uk-light uk-text-bold">Inscriptions fermées</span>
                                {% elseif complet and not (app.user and sortie.participants.contains(app.user)) %}
                                    <span class="uk-label cm-background-burnt-sienna uk-light uk-text-bold">Complet</span>
                                {% elseif app.user and sortie.participants.contains(app.user) %}
                                    <span class="uk-label uk-label-success uk-text-bold">Inscrit</span>
                                {% else %}
                                    <span class="uk-label cm-background-persian-green uk-light uk-text-bold">Disponible</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                {# -------- Colonne infos -------- #}
                <div class="uk-width-1-2@m">
                    <div class="uk-card uk-card-default uk-border-rounded uk-height-1-1">

                        {# En-tête #}
                        <div class="uk-card-header uk-padding-small" style="background-color:#f8f9fa;border-bottom:1px solid #e9ecef;">
                            <h3 class="uk-card-title uk-margin-remove-bottom cm-text-charcoal">Informations de la sortie</h3>
                            <p class="uk-text-meta uk-margin-small-top uk-text-small cm-text-charcoal" style="opacity:.7;">
                                {{ sortie.infos ?: 'Découvrez tous les détails de cette activité' }}
                            </p>
                        </div>

                        {# Corps #}
                        <div class="uk-card-body uk-padding-small">

                            {# Date début #}
                            <div class="uk-flex uk-flex-middle uk-margin-small-bottom">
                                <span uk-icon="icon: calendar; ratio: .9" class="cm-text-persian-green uk-margin-small-right"></span>
                                <div>
                                    <div class="uk-text-small uk-text-bold cm-text-charcoal">
                                        {{ sortie.dateHeureDebut|date('d/m/Y H:i') }}
                                    </div>
                                    <div class="uk-text-meta uk-text-small">Date et heure de début</div>
                                </div>
                            </div>

                            {# Limite d'inscription #}
                            <div class="uk-flex uk-flex-middle uk-margin-small-bottom">
                                <span uk-icon="icon: clock; ratio: 0.8" class="cm-text-sandy-brown uk-margin-small-right"></span>
                                <div>
                                    <div class="uk-text-small uk-text-bold cm-text-charcoal">
                                        {{ sortie.dateLimiteInscription|date('d/m/Y H:i') }}
                                    </div>
                                    <div class="uk-text-meta uk-text-small">Limite d'inscription</div>
                                </div>
                            </div>

                            {# Durée #}
                            <div class="uk-flex uk-flex-middle uk-margin-small-bottom">
                                <span uk-icon="icon: clock; ratio: .9" class="cm-text-sandy-brown uk-margin-small-right"></span>
                                <div>
                                    <div class="uk-text-small uk-text-bold cm-text-charcoal">{{ sortie.duree }} minutes</div>
                                    <div class="uk-text-meta uk-text-small">Durée de l'activité</div>
                                </div>
                            </div>

                            {# Lieu #}
                            <div class="uk-flex uk-flex-middle uk-margin-small-bottom">
                                <span uk-icon="icon: location; ratio: .9" class="cm-text-persian-green uk-margin-small-right"></span>
                                <div>
                                    <div class="uk-text-small uk-text-bold cm-text-charcoal">{{ sortie.campus.nom }}</div>
                                    <div class="uk-text-meta uk-text-small">Lieu de rendez-vous</div>
                                </div>
                            </div>

                            {# Organisateur #}
                            <div class="uk-flex uk-flex-middle uk-margin-small-bottom">
                                <span uk-icon="icon: user; ratio: .9" class="cm-text-sandy-brown uk-margin-small-right"></span>
                                <div>
                                    <div class="uk-text-small uk-text-bold cm-text-charcoal">{{ sortie.organisateur.nom }}</div>
                                    <div class="uk-text-meta uk-text-small">Organisateur</div>
                                </div>
                            </div>

                            {# Participants + jauge #}
                            <div class="uk-margin-small-bottom">
                                <div class="uk-flex uk-flex-between uk-flex-middle uk-margin-small-bottom">
                                    <span class="uk-flex uk-flex-middle">
                                        <span uk-icon="icon: users; ratio: .9" class="cm-text-persian-green uk-margin-small-right"></span>
                                        <span class="uk-text-small cm-text-charcoal">Participants inscrits</span>
                                    </span>
                                    <span class="uk-text-small uk-text-bold cm-text-charcoal">
                                        {{ inscrits }}{% if sortie.nbInscriptionMax %} / {{ sortie.nbInscriptionMax }}{% endif %}
                                    </span>
                                </div>

                                {% if sortie.nbInscriptionMax %}
                                    <progress class="uk-progress uk-progress-small uk-margin-small-bottom"
                                              value="{{ inscrits }}"
                                              max="{{ sortie.nbInscriptionMax }}">
                                    </progress>
                                {% endif %}
                            </div>
                        </div>

                        {# Footer : actions #}
                        <div class="uk-card-footer uk-padding-small uk-text-center" style="background-color:#f8f9fa;border-top:1px solid #e9ecef;">
                            {% if app.user and sortie.participants.contains(app.user) %}
                                {# Déjà inscrit → se désinscrire #}
                                <form action="{{ path('sorties_desinscription', {id: sortie.id}) }}" method="post" class="uk-width-1-1">
                                    <button type="submit" class="uk-button uk-button-danger uk-light uk-button-large uk-width-1-1">
                                        <span uk-icon="close"></span> Se désinscrire
                                    </button>
                                </form>

                            {% elseif app.user %}
                                {# Non inscrit : calcul des raisons d'indisponibilité #}
                                {% set conditions = [] %}
                                {# {% if pas_ouverte %}{% set conditions = conditions|merge(['Sortie non ouverte']) %}{% endif %}#}
                                {% if delais_depasse %}{% set conditions = conditions|merge(['Date limite dépassée']) %}{% endif %}
                                {% if complet %}{% set conditions = conditions|merge(['Sortie complète']) %}{% endif %}
                                {% if deja_debute %}
                                    <button class="uk-button uk-button-danger uk-light uk-button-large uk-width-1-1" disabled
                                            title="La sortie a déjà débuté">
                                        <span uk-icon="ban"></span> Désinscription indisponible
                                    </button>
                                {% endif %}
                                {% if conditions|length > 0 %}
                                    <button class="uk-button cm-background-burnt-sienna uk-light uk-button-large uk-width-1-1" disabled
                                            title="{{ conditions|join(' • ') }}">
                                        <span uk-icon="ban"></span> Inscription indisponible
                                    </button>

                                {% else %}
                                    <form action="{{ path('sorties_inscription', {id: sortie.id}) }}" method="post" class="uk-width-1-1">
                                        <button type="submit" class="uk-button cm-background-persian-green uk-light uk-button-large uk-width-1-1">
                                            <span uk-icon="check"></span> Je m'inscris à cette sortie
                                        </button>
                                    </form>
                                {% endif %}

                            {% else %}
                                {# Pas connecté #}
                                <a href="{{ path('app_login') }}" class="uk-button cm-background-persian-green uk-light uk-button-large uk-width-1-1">
                                    <span uk-icon="sign-in"></span> Connectez-vous pour vous inscrire
                                </a>
                            {% endif %}
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </section>

    {% if app.user is same as sortie.organisateur %}
        <button class="uk-button uk-button-danger uk-dark uk-button-large uk-width-1-1" uk-toggle="target: #modal-delete-{{ sortie.id }}">
            <span uk-icon="trash"></span> Supprimer la sortie
        </button>

        <div id="modal-delete-{{ sortie.id }}" uk-modal>
            <div class="uk-modal-dialog uk-modal-body">
                <h2 class="uk-modal-title">Confirmer la suppression</h2>
                <p>Êtes-vous sûr de vouloir supprimer cette sortie ?</p>
                <div class="uk-flex uk-flex-right uk-flex-middle uk-grid-small" uk-grid>
                    <div>
                        <button class="uk-button uk-button-default uk-modal-close" type="button">Annuler</button>
                    </div>
                    <div>
                        <form method="post" action="{{ path('sorties_delete', {'id': sortie.id}) }}">
                            <button type="submit" class="uk-button uk-button-danger">Supprimer</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <section class="uk-section cm-background-charcoal uk-light uk-section-large">
        <div class="uk-container uk-text-center">
            <h2 class="uk-heading-medium">Découvrez d'autres sorties</h2>
            <p class="uk-text-large uk-margin-medium-bottom cm-text-saffron">Explorez toutes les activités disponibles</p>
            <a href="{{ path('sorties_home') }}" class="uk-button cm-background-persian-green uk-light uk-button-large">
                <span uk-icon="grid"></span> Voir toutes les sorties
            </a>
        </div>
    </section>
{% endblock %}