[unix_http_server]
file=/run/supervisor.sock
chmod=0700
chown=webapp:web

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisord]
logfile=/var/log/supervisord.log
pidfile=/run/supervisord.pid
childlogdir=/var/log/supervisor
nodaemon=false
; ⚠️ Laisse vide ici : c’est Supervisor (pid 1) qui doit rester root pour pouvoir
; lancer/stopper proprement ; on met les *programs* en user non-root ci-dessous.

[supervisorctl]
serverurl=unix:///run/supervisor.sock

; ---------- Services ----------
[program:php-fpm]
command=/usr/sbin/php-fpm --nodaemonize --fpm-config /etc/php/php-fpm.conf
user=webapp
autostart=true
autorestart=true
startsecs=1
stopsignal=QUIT
stopwaitsecs=15
stdout_logfile=/var/log/php-fpm/supervisor.log
redirect_stderr=true
environment=PHP_FPM_PM_MAX_CHILDREN="10"

[program:nginx]
command=/usr/sbin/nginx -g 'daemon off;' -c /etc/nginx/nginx.conf
user=webapp
autostart=true
autorestart=true
startsecs=1
stopsignal=QUIT
stopwaitsecs=15
stdout_logfile=/var/log/nginx/supervisor.log
redirect_stderr=true

[group:web]
programs=php-fpm,nginx
priority=999
